<title>[[Gallery]]</title>

<p id="breadcrumbs">
	{{if .IsGlobal}}
		<span><span class='fai'>&#xe08d;</span>
		<span>[[Global Gallery]]</span></span>
	{{else}}
		<span><span class='fai'>&#xe08d;</span>
		<span>[[Gallery]]</span></span>

		<span><span class='fai'>&#xe12c;</span>
		<a href="/user/{{.GalleryUserID}}">{{.UploaderName}}</a></span>
	{{end}}

	<span data-dropdown="gallery-function" data-dropdown-onload="focusSearch()">
		{{if .IsSearch}}
		<span class='fai'>&#xe14f;</span> <span class="nc">[[Search]] "{{.SearchPattern}}"</span>
		{{else}}
		<span class='fai'>&#xe08c;</span> <span class="nc">[[Images]]</span>
		{{end}}
	</span>

	{{if .IsSelf}}
		<span onclick="selectAll()"><span class='fai'>&#xe072;</span>
		<span class="nc">[[Select All]]</span></span>

		<span onclick="invertSelection()"><span class='fai'>&#xe072;</span>
		<span class="nc">[[Inverse Selection]]</span></span>

	{{else}}
		<span onclick="expandR18()" id="show-r18" data-r18="false"><span class='fai'>&#xe11b;</span>
		<span class="nc" id="show-r18-label">[[Show R18]]</span></span>

	{{end}}

	<script type="text/javascript">
		document.title += " -- " + etc.date.format({{.Nav.Range.End}});
		document.write(buildTime({{.Nav.Range.Start}}, {{.Nav.Range.End}}));
	</script>
</p>

<div id="gallery-function" class="dropdown">
	<div>
		<input id="search-url" placeholder="[[Search]]" {{if .IsSearch}}value="{{.SearchPattern}}"{{end}}>
	</div>
	<ul>
		<li data-onclick="searchImage()">
		<span class='fai'>&#xe14f;</span> 
		<span>[[Search]]</span></li>

		{{if .IsSearch}}
		<li onclick="location.href='../../../page/1'">
		<span class='fai'>&#xe006;</span>
		<span>[[Back]]</span></li>
		{{end}}

		{{if .IsSelf}}
	</ul>
		<div>
			<input id="rename-images" placeholder="[[Rename selected]]">
		</div>
	<ul>
		<li data-onclick="alterImages('rename')"><span class='fai'>&#xe0c3;</span>
		<span>[[Rename selected]]</span></li>

		<li data-onclick="alterImages('delete')"><span class='fai'>&#xe123;</span>
		<span>[[Delete selected]]</span></li>

		<li data-onclick="alterImages('delete', true)"><span class='fai'>&#xe123;</span>
		<span>[[Delete all in this page]]</span></li>

		<li data-onclick="alterImages('~hide')"><span class='fai'>&#xe06f;</span>
		<span>[[Show/Hide selected]]</span></li>

		<li data-onclick="alterImages('~r18')"><span class='fai'>&#xe06f;</span>
		<span>[[Tag/Untag R18]]</span></li>

		<li data-dropdown="copy-function" data-subdropdown="true"><span class='fai'>&#xe04a;</span>
		<span>[[Copy selected]]</span></li>

		{{else}}
		<li data-onclick="alterImages('flag')"><span class='fai'>&#xe123;</span>
		<span>[[Flag for deletion]]</span></li>

		{{end}}
	</ul>
</div>

<div id="copy-function" class="dropdown">
	<ul>
		<li onclick="copyImageCode('url')"><span class='fai'>&#xe04a;</span>
		<span>[[Full images url]]</span></li>

		<li onclick="copyImageCode('bbcode')"><span class='fai'>&#xe04a;</span>
		<span>[[Full images bbcode]]</span></li>

		<li onclick="copyImageCode('md')"><span class='fai'>&#xe04a;</span>
		<span>[[Full images markdown]]</span></li>

		<li onclick="copyImageCode('data')"><span class='fai'>&#xe04a;</span>
		<span>[[Data images]]</span></li>
	</ul>
</div>

<textarea id="copy-code" style="display: none" class="image-code" rows="10"></textarea>

<script type="text/javascript">
	document.write(buildPager({{.IsIndexPage}}, {{.IsLastPage}},
		"{{.IndexPage}}", "{{.LastPage}}", "{{.Nav.PrevPage}}", "{{.Nav.NextPage}}",
		"{{.Nav.LastWeekPage}}", "{{.Nav.LastMonthPage}}", "{{.Nav.LastYearPage}}"));

	function focusSearch() {
		etc.id("search-url").focus();
		etc.id("search-url").select();
	}

	function selectAll() {
		etc.get(".simple-check").forEach(function(e) {
			e.checked = true;
			e.parentNode.style.backgroundColor = "#77aa8b";
		});
	}

	function invertSelection() {
		etc.get(".simple-check").forEach(function(e) {
			e.checked = !e.checked;
			e.parentNode.style.backgroundColor = e.checked ? "#77aa8b" : "#54638c";
		});
	}

	function expandR18() {
		if (etc.id("show-r18").attr("data-r18") == "false") {
			etc.get("div[data-r18=true]").forEach(function(e) {
				e.className = e.className.replace("img-r18", "");
			});
			etc.id("show-r18").attr("data-r18", "true");
			etc.id("show-r18-label").html("[[Hide R18]]");
			etc.util.cookie.write("r18", "1", 30 * 24 * 36000000);
		} else {
			etc.get("div[data-r18=true]").forEach(function(e) {
				e.className += " img-r18";
			});
			etc.id("show-r18").attr("data-r18", "false");
			etc.id("show-r18-label").html("[[Show R18]]");
			etc.util.cookie.remove("r18");
		}
	}

	function alterImages(action, all) {
		var checks = etc.get(".simple-check");
		var ids = [];

		for (var i = 0; i < checks.length; i++) {
			if (checks[i].checked || all) {
				ids.push(checks[i].getAttribute("data-id"));
			}
		}

		if (ids.length == 0) 
			return etc.wait.on(this).done();

		if (action == "delete" && !confirm("[[Confirm to delete]]: " + ids.join(","))) 
			return etc.wait.on(this).done();

		if (action == "rename" && etc.id("rename-images").value == "")
			return etc.wait.on(this).done();

		var column = "";
		if (action.charAt(0) == "~") {
			column = action.substr(1);
			action = "invert";
		}

		etc.util.ajax.post("/alter/images", { 
			"ids": ids.join(","),
			"id": "{{.GalleryUserID}}",
			"filename": etc.id("rename-images").value,
			"action": action,
			"column": column,
			"csrf": etc.util.CSRF() 
		}).then(function(e, text) {
			etc.wait.on(this).done();

			if (text == "ok") {
				if (action == "flag") alert("[[Operation completed]]");
				window.location.reload();
			} else {
				alert("[[Error: ]]" + text);
			}
		});

		return etc.wait.on(this);
	}

	function searchImage() {
		var url = etc.id("search-url").value;
		if (url == "") return etc.wait.on(this).done();

		etc.util.ajax.post("/search/image", { 
			"url": url,
			"id": "{{.GalleryUserID}}",
			"csrf": etc.util.CSRF() 
		}).then(function(e, text) {
			etc.wait.on(this).done();

			if (text.indexOf("ok::") > -1) {
				location.href = text.substr(4);
			} else {
				alert("[[Error: ]]" + text);			
			}
		});

		return etc.wait.on(this);
	}

	function copyImageCode(type) {
		var checks = etc.get(".simple-check");
		var code = [];

		for (var i = 0; i < checks.length; i++) {
			if (checks[i].checked) {
				var full = checks[i].getAttribute("data-full");

				switch (type) {
					case "url": code.push(full); break;
					case "bbcode": code.push("[img]" + full + "[/img]"); break;
					case "data": code.push("[img=data]" + full + "[/img]"); break;
					case "md": code.push("![](" + full + ")"); break;
				}
			}
		}

		etc.let.show("copy-code").$.value = code.join("\n");
	}

	function checkChanged(id) {
		var c = etc.id("img-" + id);
		c.parentNode.style.backgroundColor = c.checked ? "#77aa8b" : "#54638c";
	}

	etc.id("search-url").onkeydown = function(e) {
		e = (e) ? e : window.event;
		if (e.which == 13 || e.keyCode == 13) searchImage();
	}
</script>

<style type="text/css">
	.simple-check:checked + label:before {
		color: white !important;
	}

	.img-container span {
		display: none;
	}

	{{if not .IsSelf}}
	.img-r18 img {
		display: none;
	}

	.img-r18 {
		width: 150px !important;
		height: 150px !important;
	}

	.img-container.img-r18 span {
		display: block;
		width: 150px;
		height: 150px;
		line-height: 150px;
		vertical-align: middle;
		padding: 0;
		font-size: 42px;
		color: red;
	}
	{{end}}
</style>

<div id="gallery">
	{{range .Images}}
		<div class="image">
			<div>
				<div class="img-id">
					<input type="checkbox" class="simple-check" id="img-{{.ID}}" data-id="{{.ID}}" data-full="{{.Path}}" data-thumb="{{.ThumbPath}}" onchange="checkChanged({{.ID}})">
					<label for="img-{{.ID}}">#{{.ID}} - {{.Filename}}</label>
				</div>
				<div class="img-container {{if .R18}}img-r18{{end}}" onclick="etc.id('img-{{.ID}}').click()" ondblclick="window.open('{{.Path}}')" data-r18="{{.R18}}">
					<img src="{{.ThumbPath}}" title="[[Double click to open]]">
					<span class="fai">&#x0e03d;</span>
				</div>
			</div>

			<div class="date">
				<span class="fai">&#xe00b;</span> <a href="{{.Path}}" target="_blank">[[Open]]</a> 
				<span class="fai">&#xe06e;</span> <span title="[[Views]]">{{.Hits}}</span>
				{{if .Hide}}<span class="fai">&#xe137;</span> [[Hide]]{{end}}
				{{if .R18}}<span class="fai">&#xe137;</span> [[R18]]{{end}}
				{{if $.IsGlobal}}<span class="fai">&#xe12c;</span>
				<a href="/gallery/{{.UploaderID}}/page/1">{{.Uploader}}</a>{{end}}
				<div><script type="text/javascript">
					document.write(etc.date.format({{.Timestamp}}));
				</script></div>
			</div>
		</div>
	{{end}}
</div>

<script type="text/javascript">
	document.write(buildPager({{.IsIndexPage}}, {{.IsLastPage}},
		"{{.IndexPage}}", "{{.LastPage}}", "{{.Nav.PrevPage}}", "{{.Nav.NextPage}}",
		"{{.Nav.LastWeekPage}}", "{{.Nav.LastMonthPage}}", "{{.Nav.LastYearPage}}"));

	{{if not .IsSelf}}
	if (etc.util.cookie.read("r18") == "1") expandR18();
	{{end}}
</script>