{{if .IsLoggedIn}}
<title>[[Console]]</title>
<style type="text/css">
    .account-admin { display: inline !important; }
</style>

<p id="breadcrumbs">    
    <span><span class='fai'>&#xe0bf;</span>
    <a href="/ua/{{.ID}}/page/1">[[User Articles]]</a></span>

    <span><span class='fai'>&#xe04f;</span>
    <a href="/owa/{{.ID}}/page/1">[[Iceberg]]</a></span>

    <span><span class='fai'>&#xe0a5;</span>
    <a id="message-box-count" href="/message/{{.ID}}/page/1">[[Private Message]]</a></span>

    <span><span class='fai'>&#xe08d;</span>
    <a href="/gallery/{{.ID}}/page/1">[[Gallery]]</a></span>

    <span><span class='fai'>&#xe069;</span>
    <a data-onclick="tryLogout()">[[Log Out]]</a></span>

    <span class="account-{{.Group}}" data-dropdown="admin-nav" style="display: none">
        <span class='fai'>&#xe103;</span> 
        <span class='nc'>管理员</span>
    </span>
</p>

<div class="dropdown" id="admin-nav">
    <ul>
        <li><a href="/owa/0/page/1">站内所有文章</a></li>
        <li><a href="/config/sheet">配置文件</a></li>
        <li><a href="/database/articles/page/1">浏览数据库</a></li>
        <li><a href="/bootstrap">配置模板</a></li>
        <li><a href="/cache" target="_blank">缓存状态</a></li>
    </ul>
</div>


{{else}}
<title>[[Sign in]]</title>
<p id="breadcrumbs">
<span><span class='fai'>&#xe083;</span> [[Sign in]]</span>
<span><span class='fai'>&#xe128;</span> <a href="/account/register">[[Sign up]]</a></span>
</p>
{{end}}

<script type="text/javascript">
    {{if .IsLoggedIn}}
        var tryLogout = function(){
            etc.util.ajax.post("/logout").then(function (e, data, x) {
                etc.wait.on(this).done();
                etc.util.cookie.remove("unread");
                window.location.reload();
            });

            return etc.wait.on(this);
        }

        var tryUpdateComment = function(){

            etc.util.ajax.post("/user/update/comment", {
                "comment": etc.id("user-comment").value,
                "csrf": etc.util.CSRF()
            }).then(function(e, d, x){
                etc.wait.on(this).done();

                if (d == "ok") {
                    alert("[[Operation completed]]");
                    window.location.reload();
                } else {
                    alert("[[Error: ]]" + d);
                }
            });

            return etc.wait.on(this);
        }

        var tryUpdatePassword = function(){
            var op = etc.id("old-password").value;
            if (op === "") {
                alert("请先输入旧密码");
                return etc.wait.on(this).done();
            }

            etc.util.ajax.post("/user/update/password", {
                "old-password": op,
                "new-password": etc.id("new-password").value,
                "password-hint": etc.id("new-password-hint").value,
                "csrf": etc.util.CSRF()
            }).then(function(e, d, x){
                etc.wait.on(this).done();

                if (d == "ok") {
                    alert("[[Operation completed]]");
                    window.location.reload();
                } else {
                    alert("[[Error: ]]" + d);
                }
            });

            return etc.wait.on(this);
        }

        var tryUpdateAvatar = function(){
            etc.util.ajax.$post("/upload", {
                "image": etc.file("user-avatar")[0],
                "avatar": "true",
                "csrf": etc.util.CSRF()
            }).then(function(e, d, x){
                etc.wait.on(this).done();

                var j = JSON.parse(d);

                if (j.Avatar == "ok"){
                    alert("[[Operation completed]]");
                    etc.id("avatar-image").attr("src", j.Thumbnail).parentNode.href = j.Link;
                } else {
                    alert("[[Error: ]]" + j.R);
                }
            });

            return etc.wait.on(this);
        }

        if (window.__unread > 0) 
            etc.id("message-box-count").innerHTML += " (" + window.__unread + ")";
    {{else}}
	    var tryLogin = function(){
	        etc.let.hide("login-result");

	        etc.util.ajax.post("/login", {
	            "username" : etc.id("simple-username").value, 
	            "password" : etc.id("simple-password").value, 
	            "expire" : etc.id("simple-expire").value,
	            "csrf": etc.util.CSRF()
	        }).then(function (e, data, x) {
	            etc.wait.on(this).done();

	            if (data.indexOf("ok") == 0) {
	                window.location.href = window.location.href.split("?")[1] || "/";
	            } else {
	                var m = data.match(/Err::Login::Retry_Opportunities_(\d+)_Hint_(.+)/);
	                var h = "登入失败: " + data;
	                if (m[2]) h = "密码提示: " + m[2] + "<br>" + h;
	                
	                etc.let.show("login-result").$.html(h);
	            }
	        });

	        return etc.wait.on(this);
	    }

        window.onload = function() {
            etc.id("simple-password").on("keydown", function(ev) { 
                if(ev.keyCode == 13) etc.id("simple-login").click(); 
            });
        }
    {{end}}
</script>

{{if .IsLoggedIn}}

<table class="_table" style="width: 100%">
    <tr><td class="right-align fit">用户ID:</td><td>{{.ID}}</td></tr>
    <tr><td class="right-align fit">[[Nickname]]:</td><td>{{.NickName}}</td></tr>
    <tr><td class="right-align fit">[[Username]]:</td><td>{{.Name}}</td></tr>
    <tr><td class="right-align fit">用户组:</td><td>{{.Group}}</td></tr>

    <tr><td class="right-align fit">用户状态:</td><td>{{.Status}}</td></tr>
    
    {{range $n, $av := .UserPrivilege}}
        <tr><td class="right-align fit">{{$n}}:</td><td>{{$av}}</td></tr>
    {{end}}
    <tr><td class="right-align fit">上次登入:</td><td>
        <script type="text/javascript">
            document.write(etc.date.format({{.LastLoginDate}} * 1000, true))
        </script> @
        <a href="http://ipinfo.io/{{.LastLoginIP}}" target="_blank">{{.LastLoginIP}}</a>
    </td></tr>
    
    <tr><td class="right-align fit">注册时间:</td><td>
        <script type="text/javascript">
            document.write(etc.date.format({{.SignUpDate}} * 1000, true))
        </script>
    </td></tr>

    <tr><td class="right-align fit">上传图片:</td><td>
    <script type="text/javascript">
        document.write(({{.ImageUsage}} / 1048576).toFixed(2) + " MiB ({{.ImageUsage}} 字节)");
    </script>
    </td></tr>

    <tr><td colspan="2"><hr></td></tr>

    <tr><td class="right-align fit">用户备注:</td>
    	<td>
    		<input type="textbox" id="user-comment" style="width: 100%; max-width: 200px" value="{{.Comment}}"/>
            <button data-onclick="tryUpdateComment()">更新备注</button>
        </td>
    </tr>

    <tr><td></td><td>
    	<a href="{{.Avatar}}" style="display: block;">
        	<img id="avatar-image" style="max-width: 150px; max-height: 150px" src="{{.AvatarThumb}}">
        </a>
    </td></tr>

    <tr><td class="right-align fit">用户头像:</td><td>
        <input type="file" id="user-avatar" style="width: 100%; max-width: 200px" />
        <button data-onclick="tryUpdateAvatar()">上传图像</button>
    </td></tr>

    <tr><td colspan="2"><hr></td></tr>

    <tr><td class="right-align fit">旧密码:</td>
        <td><input type="textbox" id="old-password" style="width: 100%; max-width: 200px"/></td>
    </tr>
    <tr><td class="right-align fit">新密码:</td>
        <td><input type="textbox" id="new-password" style="width: 100%; max-width: 200px"/></td>
    </tr>
    <tr><td class="right-align fit">[[Password Hint]]:</td>
        <td>
            <input type="textbox" id="new-password-hint" style="width: 100%; max-width: 200px"/>
            <button data-onclick="tryUpdatePassword()">修改密码</button>
        </td>
    </tr>
</table>
{{else}}

<table class="_table" style="max-width: 300px;">
    <tr>
        <td class="right-align fit">[[Username]]:</td>
        <td><input type="textbox" id="simple-username" class="_f" /></td>
    </tr>
    <tr>
        <td class="right-align fit">[[Password]]:</td><td>
        <input type="password" id="simple-password" class="_f"/>
    </tr>
    <tr>
        <td class="right-align fit">[[Cookie]]:</td>
        <td>
            <select id="simple-expire" class="_f">
                <option value="-1">[[Do not use]]</option>
                <option value="1" selected>1 [[day]]</option>
                <option value="7">1 [[week]]</option>
                <option value="30">1 [[month]]</option>
                <option value="0">1 [[year]]</option>
            </select>
        </td>
    </tr>
    <tr><td></td><td>
        <button data-onclick="tryLogin()" id="simple-login">[[Sign in]]</button>
    </td></tr>
</table>

<div id="login-result" style="word-break: break-word"></div>
{{end}}