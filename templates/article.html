<title>[{{.Article.Tag}}] {{.Article.Title}}</title>
<p id="breadcrumbs">
	{{if .Article.IsMessage}}
		私信 |

		{{if .Article.IsMessageSentout}}
		{{else}}
		<a href="/new/message/{{.Article.AuthorID}}">回复</a> |
		<a data-onclick="tryUnread()">标记为未读</a> |
		{{end}}

		<a data-onclick="tryDeleteRestore()">删除私信</a> |

		{{if .Article.IsMessageSentout}}
		{{else}}
			发送者: <a href="/user/{{.Article.AuthorID}}">{{.Article.Author}}</a> |
		{{end}}
	{{else}}
		文章
		{{if .IsLoggedIn}}
			<a id="get-function" href="javascript:showFunction()" class="smaller">&#9660;</a>
		{{end}}
		|

		{{if .Article.Revision}}
			修订: <a id="get-history" data-onclick="getHistory()">{{.Article.Revision}}次</a> |
		{{else}}
			无修订 |
		{{end}}

		{{if .Article.ParentID}}
		{{else}}
			{{if .Article.Children}}
			<a href="/reply/{{.Article.ID}}/page/1">{{.Article.Children}}篇</a> /
			{{end}}
			<a href="/new/article/{{.Article.ID}}?/reply/{{.Article.ID}}/page/1">回复</a> |
		{{end}}

		作者: <a href="/user/{{.Article.AuthorID}}">{{.Article.Author}}</a> |

		标签: <a href="/tag/{{.Article.Tag}}/page/1">{{.Article.Tag}}</a> |

		{{.Article.Hits}}次查看 |
	{{end}}
	<a href="javascript:switchView()" id="switch-mode" data-mode="normal">相册模式</a>
</p>

<div id="article-history-underlay" class="dropdown-underlay" onclick="hideHistory()"></div>
<div id="article-history" class="dropdown"></div>

<div id="article-function-underlay" class="dropdown-underlay" onclick="hideFunction()"></div>
<div id="article-function" class="dropdown">
	<ul>
		{{if .IsLoggedIn}}
			{{if .IsAuthorSelf}}
				{{if .Article.IsMessage}}{{else}}
					<li><a href='javascript:goEdit()'>编辑</a></li>
				{{end}}

				<li><a data-onclick="tryDeleteRestore()">
					{{if .Article.Deleted}}恢复{{else}}删除{{end}}
				</a></li>
			{{end}}

			{{if .CanMakeLocked}}
				<li><a data-onclick="goLock()">
					{{if .Article.Locked}}解锁{{else}}锁定{{end}}
				</a></li>
			{{end}}	
		{{end}}
	</ul>
</div>

<script type="text/javascript">
	function goEdit() {
		window.location.href="/edit/article/{{.Article.ID}}?" + window.location.href;
	}

	function goLock() {
		etc.util.ajax.post("/lock/article/{{.Article.ID}}", {"csrf":etc.util.CSRF()}).then(function(e, d, x){
			etc.wait.on(this).done();

			if (d == "ok") {
				alert("操作成功");
				window.location.reload();
			}
			else {
				alert("发生错误: " + d);
			}
		});

		return etc.wait.on(this);
	}

	function hideFunction() {
		etc.let.hide("article-function-underlay");
		etc.let.hide("article-function");
	}

	function showFunction() {
		if (etc.get("#article-function li").length < 1) return;

		etc.let.show("article-function").$.style.left = 
			(etc.id("get-function").getBoundingClientRect().left - 10) + "px";;
		etc.let.show("article-function-underlay");
	}

	function hideHistory() {
		etc.let.hide("article-history-underlay");
		etc.let.hide("article-history");
	}

	function getHistory() {
		if (etc.id("article-history").innerHTML != "") {
			etc.let.show("article-history");
			etc.let.show("article-history-underlay");
			return etc.wait.on(this).done();
		}

		etc.util.ajax.get("/article/{{.Article.ID}}/history?" + new Date().getTime()).then(function(e, d, x){
			etc.wait.on(this).done();

			getHistory.history = JSON.parse(d);
			var has = false;
			var _html = ["</ul>"];
			for(var k in getHistory.history) {
				has = true;
				_html.push("<li data-onclick='getHistoryVersion(" + k + ")' onclick='etc.wait.onclick(this)'>" + 
					getHistory.history[k].User + " - " + 
					etc.date.format(getHistory.history[k].Date, true) + "</li>");
			}
			if (!has) _html.push("<li>无历史版本</li>");
			_html.push("<ul style='cursor: pointer'>");

			var l = etc.id("get-history").getBoundingClientRect().left - 10;

			etc.let.show("article-history").$.html(_html.reverse().join('')).style.left = l + "px";
			etc.let.show("article-history-underlay");
		});

		return etc.wait.on(this);
	}

	function getHistoryVersion(rev) {
		etc.util.ajax.get("/article/{{.Article.ID}}/history/" + rev).then(function(e, d, x){
			etc.wait.on(this).done();

			if (x.status == 503) {
				alert("您没有查看权限");
				return;
			}
			
			var j = JSON.parse(d);
			etc.let.show("article-revision").$.html("<em>历史版本: " + 
				etc.date.format(getHistory.history[rev].Date, true) + " (#" + rev + ")</em>");

			etc.id("article-title").html(j.Title);
			etc.id("article-content").html(etc.string.unescape(j.Content));
			var g = etc.id("gallery");
			if (g && g.parentNode) g.parentNode.removeChild(g);

			hideHistory();
			var el = etc.id("switch-mode");

			if (el.attr("data-mode") == "gallery") {
				el.attr("data-mode", "normal");
				el.innerHTML = "相册模式";
				etc.let.show("article-content");
			}
		});
		return etc.wait.on(this);
	}

	function tryDeleteRestore(){
		etc.util.ajax.post("/delete/article/{{.Article.ID}}/true", {
			"csrf": etc.util.CSRF()
		}).then(function(error, text, xhr) {
			etc.wait.on(this).done();

			if (text == "ok") {
				alert("操作成功");
				window.location.reload();
			} else {
				alert("发生错误: " + text);			
			}
		});

		return etc.wait.on(this);
	}

	function tryUnread() {

		etc.util.ajax.post("/unread/message/{{.Article.ID}}", {"csrf": etc.util.CSRF()}).then(function(error, text, xhr) {
			etc.wait.on(this).done();

			if (text == "ok") {
				alert("已将该消息标记为未读");
				window.history.back();
			} else {
				alert("发生错误: " + text);
			}
		});

		return etc.wait.on(this);
	}

	function switchView() {
		etc.util.lazyLoad(["/assets/gallery.js"], function(){
			var el = etc.id("switch-mode");

			if (el.attr("data-mode") == "normal") {
				el.attr("data-mode", "gallery");
				el.innerHTML = "文章模式";
				Gallery._Gallery();
			} else {
				el.attr("data-mode", "normal");
				el.innerHTML = "相册模式";
				Gallery._Normal();
			}
		})
	}
</script>

<div>
	<h1 id="article-title">
	{{.Article.Title}}
	</h1>

	<ul>
		{{if .Article.ParentID}}
		<li>父文章: <a href="/article/{{.Article.ParentID}}">{{.Article.ParentTitle}}</a></li>
		{{end}}

		<li id="article-revision">发布日期:
			<script type="text/javascript">
				document.write(etc.date.format({{.Article.ModTimestamp}}, true));
			</script>
		</li>

		{{if .IsEditedByOthers}}
		<li><em>文章原作者: <a href="/user/{{.Article.OriginalAuthorID}}">{{.Article.OriginalAuthor}}</a></em></li>
		{{end}}

		{{if .Article.Deleted}}
		<li><em>该文章已删除</em></li>
		{{end}}

		{{if .Article.Locked}}
		<li><em>文章已被锁定</em></li>
		{{end}}

		{{if .Article.IsRestricted}}
		<li><em>您没有查看权限</em></li>
		{{end}}

		{{if .Article.IsOthersMessage}}
		<li><em>这是他人私信文章</em></li>
		{{end}}
	</ul>
</div>

<hr>

<div id="article-content">
{{.Article.Content}}
</div>